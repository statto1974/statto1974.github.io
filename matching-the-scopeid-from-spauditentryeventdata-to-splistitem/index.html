<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Matching the ScopeId from SPAuditEntry.EventData to SPListItem - Toby Statham</title><meta name="description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"><link rel="alternate" type="application/atom+xml" href="https://wutek.co.uk/feed.xml"><link rel="alternate" type="application/json" href="https://wutek.co.uk/feed.json"><meta property="og:title" content="Matching the ScopeId from SPAuditEntry.EventData to SPListItem"><meta property="og:site_name" content="Toby Statham"><meta property="og:description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the&hellip;"><meta property="og:url" content="https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@this_is_wutek"><meta name="twitter:title" content="Matching the ScopeId from SPAuditEntry.EventData to SPListItem"><meta name="twitter:description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the&hellip;"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://wutek.co.uk/assets/css/style.css?v=9b8c2c950ce971bb347897f7e2550d3d"><link rel="stylesheet" href="https://wutek.co.uk/assets/css/prism-dark.css?v=4cc85e12ca94c0614c9359a37eb69a0c"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"},"headline":"Matching the ScopeId from SPAuditEntry.EventData to SPListItem","datePublished":"2008-02-06T09:09","dateModified":"2021-05-04T08:35","description":"To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the&hellip;","author":{"@type":"Person","name":"Toby Statham"},"publisher":{"@type":"Organization","name":"Toby Statham"}}</script></head><body><header class="top"><div class="top__logo"><a class="logo" href="https://wutek.co.uk/">Toby Statham</a></div><div class="top__search search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><svg class="search__icon" role="presentation" height="17" width="17"><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#search"/></svg><form action="https://wutek.co.uk/search.html" class="search__form" role="search"><input type="search" name="q" placeholder="Search documentation ..." aria-label="Search" class="search__input js-search-input"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__button js-search-btn" aria-label="Search"><span>Search</span> <svg role="presentation" focusable="false" height="17" width="17"><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#search"/></svg></button></div></header><main class="main"><div class="main__left"><div class="main__left-inner"><div class="main__left-content"><article class="post"><header><h1 class="post__title">Matching the ScopeId from SPAuditEntry.EventData to SPListItem</h1></header><div class="post__entry"><p>To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem.</p><p>Here is what I mean</p><p>The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match the Scope returned in the XML to SPSite, SPWeb and SPList object you would use the Id property of this object, but not for the SPListItem.</p><p>&lt;roleid&gt;1073741826&lt;/roleid&gt;<br>&lt;principalid&gt;11&lt;/principalid&gt;<br>&lt;scope&gt;72EEC412-B14B-4EFB-AB95-EA821A3A4C63&lt;/scope&gt;</p><p>You need to use the 'ScopeId' column of the SPListItem</p><p>So why can't I just use the SPAuditQuery.RestrictToListItem method to return the audit entries for that SPListItem.</p><p>It doesn't work, that's why and this has been confirmed by MS Support.</p><p>Here is a workaround that will link the ScopeId to the SPListItem that triggered the audit entry</p><p><code><br>using System;<br>using System.Collections.Generic;<br>using System.Text;<br>using Microsoft.SharePoint;</code><code>namespace ConsoleApplication1<br>{<br>  class Program<br>  {<br>  static void Main(string[] args)<br>  {</code></p><p>string siteUrl = "http://url";<br>  string listName = "TheList";<br>  string scopeIdFromItem = string.Empty;<br>  string scopeIdFromChange = string.Empty;</p><p>try<br>  {<br>  using (SPSite site = new SPSite(siteUrl))<br>  {<br>  using (SPWeb web = site.OpenWeb())<br>  {</p><p>SPList list = web.Lists[listName];</p><p>SPRegionalSettings regionalSettings = web.RegionalSettings;<br>  SPTimeZone timeZone = regionalSettings.TimeZone;</p><p>SPAuditQuery query = new SPAuditQuery(site);<br>  SPAuditEntryCollection auditEntries = site.Audit.GetEntries(query);</p><p>foreach (SPAuditEntry auditEntry in auditEntries)<br>  {<br>  if (IsSecurityEvent(auditEntry))<br>  {<br>  try<br>  {<br>  if (auditEntry.Event.ToString().ToUpper() == "SECROLEBINDUPDATE")<br>  {</p><p>// Should really do a proper XML query here, but for demo just do some string stuff<br>  scopeIdFromChange = auditEntry.EventData.ToString().Substring((auditEntry.EventData.ToString().Length - 44), 36);</p><p>foreach (SPListItem item in list.Items)<br>  {</p><p>// Square brackets round the scope id need to be removed<br>  scopeIdFromItem = item["ScopeId"].ToString().Substring(1, 36);</p><p>if (scopeIdFromChange == scopeIdFromItem)<br>  {<br>  Console.Write("Event Data : "); Console.WriteLine(auditEntry.EventData.ToString());<br>  Console.Write("Occurred : "); Console.WriteLine(timeZone.UTCToLocalTime(auditEntry.Occurred));</p><p>if (list.BaseType == SPBaseType.DocumentLibrary)<br>  {<br>  Console.WriteLine("Security changed on file: " + item.File.ToString());<br>  }<br>  if (list.BaseType == SPBaseType.GenericList)<br>  {<br>  Console.WriteLine("Security changed on item: " + item.Name.ToString());<br>  }<br>  }<br>  else<br>  {<br>  Console.WriteLine("No item found in list " + siteUrl + "/" + listName + " for " + auditEntry.EventData.ToString());<br>  }<br>  }<br>  }<br>  }<br>  catch (Exception ex)<br>  {<br>  Console.WriteLine(ex.Message.ToString());<br>  }</p><p>}<br>  }<br>  }<br>  }<br>  }<br>  catch (Exception ex)<br>  {<br>  Console.WriteLine(ex.Message);<br>  }<br>  }</p><p>private static bool IsSecurityEvent(SPAuditEntry entryToTest)<br>  {<br>  SPAuditEventType[] SECURITY_EVENTS = new SPAuditEventType[]<br>  {<br>  SPAuditEventType.SecGroupCreate,<br>  SPAuditEventType.SecGroupDelete,<br>  SPAuditEventType.SecGroupMemberAdd,<br>  SPAuditEventType.SecGroupMemberDel,<br>  SPAuditEventType.SecRoleBindBreakInherit,<br>  SPAuditEventType.SecRoleBindInherit,<br>  SPAuditEventType.SecRoleBindUpdate,<br>  SPAuditEventType.SecRoleDefBreakInherit,<br>  SPAuditEventType.SecRoleDefCreate,<br>  SPAuditEventType.SecRoleDefDelete,<br>  SPAuditEventType.SecRoleDefModify<br>  };</p><p>foreach (SPAuditEventType eventType in SECURITY_EVENTS)<br>  {<br>  if (eventType == entryToTest.Event) return true;<br>  }</p><p>return false;</p><p>}</p><p>}</p><p>}</p><p></p></div><footer><div class="post__footer-top"><div class="post__meta"><time datetime="2008-02-06T09:09">February 6, 2008 </time>by <a href="https://wutek.co.uk/authors/toby-statham/" rel="author" title="Toby Statham">Toby Statham </a><span>Updated on: <time datetime="2021-05-04T08:35">May 4, 2021</time></span></div><div class="post__share"><button class="post__share-button js-post__share-button" aria-label="Share"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#share"></use></svg></button><div class="post__share-popup js-post__share-popup"></div></div></div><div class="post__footer-bottom"><ul class="post__tag"><li><a href="https://wutek.co.uk/tags/auditing/">Auditing</a></li><li><a href="https://wutek.co.uk/tags/bugs/">Bugs</a></li></ul><div class="post__bio"><p><a href="https://wutek.co.uk/authors/toby-statham/"><strong>Toby Statham</strong> </a>Independent Microsoft 365 / SharePoint / Power Platform Specialist and an associate consultant at Aiimi, an Information Management company</p></div></div></footer></article><nav><ul class="posts-nav"><li class="posts-nav__prev"><span>Previous: </span><a href="https://wutek.co.uk/attempted-to-read-write-to-protected-memory-error-on-nlb-web-frontend-server/" class="invert" rel="prev" title="&quot;Attempted to read write to protected memory&quot; error on NLB Web Frontend Server">&quot;Attempted to read write to protected memory&quot; error on NLB Web Frontend Server</a></li><li class="posts-nav__next"><span>Next: </span><a href="https://wutek.co.uk/invalid-object-name-groups-when-using-psconfig/" class="invert" rel="next" title="Invalid object name &#x27;Groups&#x27; when using PSCONFIG">Invalid object name &#x27;Groups&#x27; when using PSCONFIG</a></li></ul></nav><div class="post-comments" id="post-comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                             this.page.url = 'https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/';
                     		this.page.identifier = '14';
                         };
                     
                         var disqus_loaded = false;
                     
                         function publiiLoadDisqus() {
                             if(disqus_loaded) {
                                 return false;
                             }
                     
                             var top = document.getElementById('disqus_thread').offsetTop;
                     
                             if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                                 disqus_loaded = true;
                     
                                 (function () {
                                     var d = document, s = d.createElement('script');
                                     s.src = 'https://wutek.disqus.com/embed.js';
                                     s.setAttribute('data-timestamp', +new Date());
                                     (d.head || d.body).appendChild(s);
                                 })();
                             }
                         }
                     
                         publiiLoadDisqus();
                     
                         window.onscroll = function() {
                             publiiLoadDisqus();
                         };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><aside class="main__left-aside"><div class="main__left-aside__inner"><h3>On this page</h3><nav class="aside-toc" id="aside-toc"></nav></div></aside></div></div><div class="main__right"><div class="main__right-inner"><div class="footer main__right-footer"><div class="footer__copy">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii</a></div></div></div></div></main><footer class="footer"><div class="footer__wrap"><div class="footer__inner"><div class="footer__copy">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii</a></div></div></div></footer><div class="post__progress" id="js-post__progress" aria-hidden="true"></div><div class="newsletter-popup" data-show-on-scroll="800px" data-show-after-time="5000ms"><button class="btn white newsletter-popup__close">&times;</button><h3>Subscribe</h3><p>Get the latest news, updates and more delivered directly to your email inbox</p><form>...</form></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',        
        submenuWidth: 300,        
        mobileMenuExpandableSubmenus: true,
        isHoverMenu: false,
        ariaButtonAttribute: 'aria-expanded',
   };</script><script src="https://wutek.co.uk/assets/js/html-contents.min.js?v=169077c370ab8ca62b029845f80f7fd5" defer="defer"></script><script>document.addEventListener("DOMContentLoaded", function(event) {
            htmlContents('#aside-toc', {
                area: '.post__entry',
                top: 2,
                bottom: 3,
                listType: 'o',
                filter: function(arr) {
                    return !arr.matches('.noOutline')
                },
                addIds: true,
                addLinks: true
            });

            setTimeout(function() {
                handleActiveClass('#aside-toc');
            }, 0);
        })</script><script defer="defer" src="https://wutek.co.uk/assets/js/scripts.min.js?v=2e5cce97094c516b8f7e6af7e7cd3e09"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://wutek.co.uk/assets/js/prism.js?v=277309e26a038bf312a7e8aa239cfbd8"></script><script defer="defer" src="https://wutek.co.uk/assets/js/prism-line-numbers.min.js?v=13275d3ac10d7028cf6a6f5da276f68c"></script><script defer="defer" src="https://wutek.co.uk/assets/js/prism-copy-to-clipboard.min.js?v=fabfc3fd9af83cda5208ba2e9f9ed238"></script></body></html>