<!DOCTYPE html><html lang="en-gb" data-theme="green-gray"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Matching the ScopeId from SPAuditEntry.EventData to SPListItem - Toby Statham</title><meta name="description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem. Here is what I mean The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"><meta property="og:title" content="Matching the ScopeId from SPAuditEntry.EventData to SPListItem"><meta property="og:site_name" content="Toby Statham"><meta property="og:description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem. Here is what I mean The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match&hellip;"><meta property="og:url" content="https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@this_is_wutek"><meta name="twitter:title" content="Matching the ScopeId from SPAuditEntry.EventData to SPListItem"><meta name="twitter:description" content="To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem. Here is what I mean The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match&hellip;"><link rel="alternate" type="application/atom+xml" href="https://wutek.co.uk/feed.xml"><link rel="alternate" type="application/json" href="https://wutek.co.uk/feed.json"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>:root {
               --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
               --heading-font: 'Playfair Display', serif;
               --logo-font: var(--body-font);
               --menu-font: var(--heading-font);
            }</style><link rel="stylesheet" href="https://wutek.co.uk/assets/css/style.css?v=076b19ff0048426f36c3ff3f27f97211"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://wutek.co.uk/matching-the-scopeid-from-spauditentryeventdata-to-splistitem/"},"headline":"Matching the ScopeId from SPAuditEntry.EventData to SPListItem","datePublished":"2008-02-06T09:09","dateModified":"2021-05-04T08:35","description":"To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem. Here is what I mean The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match&hellip;","author":{"@type":"Person","name":"Toby Statham"},"publisher":{"@type":"Organization","name":"Toby Statham"}}</script></head><body><header class="header" id="js-header"><div><a class="logo" href="https://wutek.co.uk/">Toby Statham</a><div class="search"><div class="search__overlay js-search-overlay"><form action="https://wutek.co.uk/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="Search articles..." aria-label="Search input" autofocus="autofocus"> <button class="search__submit" aria-label="Search">Search</button></form></div><button class="search__btn js-search-btn" aria-label="Search"><svg height="17" width="17"><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#search"/></svg></button></div></div></header><main><article class="post"><header class="post__inner post__header--centered"><h1 class="h0 post__title">Matching the ScopeId from SPAuditEntry.EventData to SPListItem</h1><div class="post__meta"><div class="post__meta__author"><div><a href="https://wutek.co.uk/authors/toby-statham/" class="post__author">Toby Statham</a> <time datetime="2008-02-06T09:09" class="post__date">February 6, 2008</time></div></div></div></header><div class="post__body"><div class="post__inner"><div class="post__entry"><p>To match the ScopeId in the EventData property of the SPAuditEntry to a SPListItem you need to use the hidden column 'ScopeId' and not the Id property of SPListItem.</p><p>Here is what I mean</p><p>The following XML is returned in the EventData proprty for a SPAuditEventType of SecRoleBindUpdate. To match the Scope returned in the XML to SPSite, SPWeb and SPList object you would use the Id property of this object, but not for the SPListItem.</p><p>&lt;roleid&gt;1073741826&lt;/roleid&gt;<br>&lt;principalid&gt;11&lt;/principalid&gt;<br>&lt;scope&gt;72EEC412-B14B-4EFB-AB95-EA821A3A4C63&lt;/scope&gt;</p><p>You need to use the 'ScopeId' column of the SPListItem</p><p>So why can't I just use the SPAuditQuery.RestrictToListItem method to return the audit entries for that SPListItem.</p><p>It doesn't work, that's why and this has been confirmed by MS Support.</p><p>Here is a workaround that will link the ScopeId to the SPListItem that triggered the audit entry</p><p><code><br>using System;<br>using System.Collections.Generic;<br>using System.Text;<br>using Microsoft.SharePoint;</code><code>namespace ConsoleApplication1<br>{<br>  class Program<br>  {<br>  static void Main(string[] args)<br>  {</code></p><p>string siteUrl = "http://url";<br>  string listName = "TheList";<br>  string scopeIdFromItem = string.Empty;<br>  string scopeIdFromChange = string.Empty;</p><p>try<br>  {<br>  using (SPSite site = new SPSite(siteUrl))<br>  {<br>  using (SPWeb web = site.OpenWeb())<br>  {</p><p>SPList list = web.Lists[listName];</p><p>SPRegionalSettings regionalSettings = web.RegionalSettings;<br>  SPTimeZone timeZone = regionalSettings.TimeZone;</p><p>SPAuditQuery query = new SPAuditQuery(site);<br>  SPAuditEntryCollection auditEntries = site.Audit.GetEntries(query);</p><p>foreach (SPAuditEntry auditEntry in auditEntries)<br>  {<br>  if (IsSecurityEvent(auditEntry))<br>  {<br>  try<br>  {<br>  if (auditEntry.Event.ToString().ToUpper() == "SECROLEBINDUPDATE")<br>  {</p><p>// Should really do a proper XML query here, but for demo just do some string stuff<br>  scopeIdFromChange = auditEntry.EventData.ToString().Substring((auditEntry.EventData.ToString().Length - 44), 36);</p><p>foreach (SPListItem item in list.Items)<br>  {</p><p>// Square brackets round the scope id need to be removed<br>  scopeIdFromItem = item["ScopeId"].ToString().Substring(1, 36);</p><p>if (scopeIdFromChange == scopeIdFromItem)<br>  {<br>  Console.Write("Event Data : "); Console.WriteLine(auditEntry.EventData.ToString());<br>  Console.Write("Occurred : "); Console.WriteLine(timeZone.UTCToLocalTime(auditEntry.Occurred));</p><p>if (list.BaseType == SPBaseType.DocumentLibrary)<br>  {<br>  Console.WriteLine("Security changed on file: " + item.File.ToString());<br>  }<br>  if (list.BaseType == SPBaseType.GenericList)<br>  {<br>  Console.WriteLine("Security changed on item: " + item.Name.ToString());<br>  }<br>  }<br>  else<br>  {<br>  Console.WriteLine("No item found in list " + siteUrl + "/" + listName + " for " + auditEntry.EventData.ToString());<br>  }<br>  }<br>  }<br>  }<br>  catch (Exception ex)<br>  {<br>  Console.WriteLine(ex.Message.ToString());<br>  }</p><p>}<br>  }<br>  }<br>  }<br>  }<br>  catch (Exception ex)<br>  {<br>  Console.WriteLine(ex.Message);<br>  }<br>  }</p><p>private static bool IsSecurityEvent(SPAuditEntry entryToTest)<br>  {<br>  SPAuditEventType[] SECURITY_EVENTS = new SPAuditEventType[]<br>  {<br>  SPAuditEventType.SecGroupCreate,<br>  SPAuditEventType.SecGroupDelete,<br>  SPAuditEventType.SecGroupMemberAdd,<br>  SPAuditEventType.SecGroupMemberDel,<br>  SPAuditEventType.SecRoleBindBreakInherit,<br>  SPAuditEventType.SecRoleBindInherit,<br>  SPAuditEventType.SecRoleBindUpdate,<br>  SPAuditEventType.SecRoleDefBreakInherit,<br>  SPAuditEventType.SecRoleDefCreate,<br>  SPAuditEventType.SecRoleDefDelete,<br>  SPAuditEventType.SecRoleDefModify<br>  };</p><p>foreach (SPAuditEventType eventType in SECURITY_EVENTS)<br>  {<br>  if (eventType == entryToTest.Event) return true;<br>  }</p><p>return false;</p><p>}</p><p>}</p><p>}</p><p></p></div><footer class="post__footer"><div class="post__updated">Updated: <time datetime="2021-05-04T08:35">May 4, 2021</time></div><div class="post__tag"><span>Tags:</span><ul class="post__tag__list"><li><a href="https://wutek.co.uk/tags/auditing/" title="Auditing">Auditing</a></li><li><a href="https://wutek.co.uk/tags/bugs/" title="Bugs">Bugs</a></li></ul></div><div class="post__meta"><div class="post__meta__share"><h3>Share this:</h3></div></div></footer></div></div></article><div class="section post__related"><div class="wrapper"><h3 class="h4 section__title">You may also like:</h3><div class="card-container card-container--col4"><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/traversing-taxonomy-terms-from-branch-to-leaf/" class="invert">Traversing Taxonomy Terms from branch to leaf</a></h2><p>I had a need to show the path...</p><footer class="card__footer"><time datetime="2013-01-29T10:15">January 29, 2013 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Ftraversing-taxonomy-terms-from-branch-to-leaf%2F&title=Traversing%20Taxonomy%20Terms%20from%20branch%20to%20leaf" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/using-the-bdc-to-populate-user-profiles-from-a-sql-server-database-part-two/" class="invert">Using the BDC to populate user profiles from a SQL Server database - Part Two</a></h2><p>This is the second part of a two...</p><footer class="card__footer"><time datetime="2007-11-02T09:46">November 2, 2007 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Fusing-the-bdc-to-populate-user-profiles-from-a-sql-server-database-part-two%2F&title=Using%20the%20BDC%20to%20populate%20user%20profiles%20from%20a%20SQL%20Server%20database%20-%20Part%20Two" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article></div></div></div></main><footer class="footer section section--lightest"><div class="footer__inner"><a class="logo footer__logo" href="https://wutek.co.uk/">Toby Statham</a><div class="footer__copyright"><p>Powered by Publii</p></div></div><button class="footer__bttop js-scroll-to-top" aria-label="Back to top"><svg><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#toparrow"/></svg></svg></button></footer><script defer="defer" src="https://wutek.co.uk/assets/js/scripts.min.js?v=11cb42b202c1c2462a7002b62194e351"></script><script>window.publiiThemeMenuConfig = {    
      mobileMenuMode: 'sidebar',
      animationSpeed: 300,
      submenuWidth: 'auto',
      doubleClickTime: 500,
      mobileMenuExpandableSubmenus: true, 
      relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>