<!DOCTYPE html><html lang="en-gb" data-theme="green-gray"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RunAs method for running code in specific user SPServiceContext - Toby Statham</title><meta name="description" content="You may have the need to run some code in a SPServiceContext of a specific user. e.g. when dealing with user profiles or activities. This can be achieved by using a combination of the SPUser, WindowsIdentity, GenericPrincipal and the GetContext method of SPServiceContext. From these we can set the HttpContext.Current.User&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://wutek.co.uk/runas-method-for-running-code-in-specific-user-spservicecontext/"><meta property="og:title" content="RunAs method for running code in specific user SPServiceContext"><meta property="og:site_name" content="Toby Statham"><meta property="og:description" content="You may have the need to run some code in a SPServiceContext of a specific user. e.g. when dealing with user profiles or activities. This can be achieved by using a combination of the SPUser, WindowsIdentity, GenericPrincipal and the GetContext method of SPServiceContext. From these we can set the HttpContext.Current.User&hellip;"><meta property="og:url" content="https://wutek.co.uk/runas-method-for-running-code-in-specific-user-spservicecontext/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@this_is_wutek"><meta name="twitter:title" content="RunAs method for running code in specific user SPServiceContext"><meta name="twitter:description" content="You may have the need to run some code in a SPServiceContext of a specific user. e.g. when dealing with user profiles or activities. This can be achieved by using a combination of the SPUser, WindowsIdentity, GenericPrincipal and the GetContext method of SPServiceContext. From these we can set the HttpContext.Current.User&hellip;"><link rel="alternate" type="application/atom+xml" href="https://wutek.co.uk/feed.xml"><link rel="alternate" type="application/json" href="https://wutek.co.uk/feed.json"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>:root {
               --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
               --heading-font: 'Playfair Display', serif;
               --logo-font: var(--body-font);
               --menu-font: var(--heading-font);
            }</style><link rel="stylesheet" href="https://wutek.co.uk/assets/css/style.css?v=076b19ff0048426f36c3ff3f27f97211"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://wutek.co.uk/runas-method-for-running-code-in-specific-user-spservicecontext/"},"headline":"RunAs method for running code in specific user SPServiceContext","datePublished":"2011-10-25T14:07","dateModified":"2021-05-04T08:35","description":"You may have the need to run some code in a SPServiceContext of a specific user. e.g. when dealing with user profiles or activities. This can be achieved by using a combination of the SPUser, WindowsIdentity, GenericPrincipal and the GetContext method of SPServiceContext. From these we can set the HttpContext.Current.User&hellip;","author":{"@type":"Person","name":"Toby Statham"},"publisher":{"@type":"Organization","name":"Toby Statham"}}</script></head><body><header class="header" id="js-header"><div><a class="logo" href="https://wutek.co.uk/">Toby Statham</a><div class="search"><div class="search__overlay js-search-overlay"><form action="https://wutek.co.uk/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="Search articles..." aria-label="Search input" autofocus="autofocus"> <button class="search__submit" aria-label="Search">Search</button></form></div><button class="search__btn js-search-btn" aria-label="Search"><svg height="17" width="17"><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#search"/></svg></button></div></div></header><main><article class="post"><header class="post__inner post__header--centered"><h1 class="h0 post__title">RunAs method for running code in specific user SPServiceContext</h1><div class="post__meta"><div class="post__meta__author"><div><a href="https://wutek.co.uk/authors/toby-statham/" class="post__author">Toby Statham</a> <time datetime="2011-10-25T14:07" class="post__date">October 25, 2011</time></div></div></div></header><div class="post__body"><div class="post__inner"><div class="post__entry"><p>You may have the need to run some code in a SPServiceContext of a specific user. e.g. when dealing with user profiles or activities.</p><p>This can be achieved by using a combination of the SPUser, WindowsIdentity, GenericPrincipal and the GetContext method of SPServiceContext.</p><p>From these we can set the HttpContext.Current.User property to the specified user.</p><p>Don't forget to set the context back after the code has executed!</p><p>Below is a helper method that makes this very easy.</p><p>I haven't done any solid testing on performance etc. so the usual caveats apply.</p><p>[sourcecode language="csharp"]</p><p>// Example calling code</p><p>RunAs(&quot;http://asharepointsite&quot;, &quot;THEDOMAIN\THEUSER&quot;, c =&gt;<br>{<br>// The code to execute. e.g. get a the UserProfileManager as the passed in user<br>var upm = new UserProfileManager(c, true);</p><p>// Do some stuff to the UPM as the passed in user<br>});</p><p>// Helper method</p><p>private static void RunAs(string siteUrl, string userName, Action&lt;SPServiceContext&gt; contextToUse)<br>{<br>try<br>{<br>var currentSetting = false;<br>var currentHttpContext = HttpContext.Current;<br>SPUser currentUser = null;</p><p>if (SPContext.Current != null)<br>{<br>if (SPContext.Current.Web != null)<br>{<br>currentUser = SPContext.Current.Web.CurrentUser;<br>}<br>}</p><p>SPSecurity.RunWithElevatedPrivileges(delegate<br>{<br>using (var site = new SPSite(siteUrl))<br>{<br>using (var web = site.OpenWeb())<br>{<br>try<br>{<br>var user = web.EnsureUser(userName);</p><p>currentSetting = web.AllowUnsafeUpdates;<br>web.AllowUnsafeUpdates = true;</p><p>var request = new HttpRequest(&quot;&quot;, web.Url, &quot;&quot;);</p><p>HttpContext.Current = new HttpContext(request,<br>new HttpResponse(<br>new StringWriter(CultureInfo.CurrentCulture)));</p><p>HttpContext.Current.Items[&quot;HttpHandlerSPWeb&quot;] = web;</p><p>var wi = WindowsIdentity.GetCurrent();</p><p>var newfield = typeof (WindowsIdentity).GetField(&quot;m_name&quot;,<br>BindingFlags.NonPublic |<br>BindingFlags.Instance);</p><p>if (newfield != null) newfield.SetValue(wi, user.LoginName);</p><p>if (wi != null) HttpContext.Current.User = new GenericPrincipal(wi, new string[0]);</p><p>var elevatedContext = SPServiceContext.GetContext(HttpContext.Current);</p><p>contextToUse(elevatedContext);</p><p>//Set the HTTPContext back to &quot;normal&quot;<br>HttpContext.Current = currentHttpContext;</p><p>if (currentUser != null)<br>{<br>var winId = WindowsIdentity.GetCurrent();</p><p>var oldField = typeof (WindowsIdentity).GetField(&quot;m_name&quot;,<br>BindingFlags.NonPublic |<br>BindingFlags.Instance);</p><p>if (oldField != null) oldField.SetValue(winId, currentUser.LoginName);</p><p>if (winId != null)<br>HttpContext.Current.User = new GenericPrincipal(winId, new string[0]);<br>}<br>}<br>catch (Exception ex)<br>{<br>// Log or whatever<br>}<br>finally<br>{<br>web.AllowUnsafeUpdates = currentSetting;<br>}<br>}<br>}<br>});</p><p>}<br>catch (Exception exO)<br>{<br>// Log or whatever<br>}<br>}</p><p>[/sourcecode]</p></div><footer class="post__footer"><div class="post__updated">Updated: <time datetime="2021-05-04T08:35">May 4, 2021</time></div><div class="post__tag"><span>Tags:</span><ul class="post__tag__list"><li><a href="https://wutek.co.uk/tags/api/" title="API">API</a></li><li><a href="https://wutek.co.uk/tags/runwithelevatedprivileges/" title="RunWithElevatedPrivileges">RunWithElevatedPrivileges</a></li><li><a href="https://wutek.co.uk/tags/spservicecontext/" title="SPServiceContext">SPServiceContext</a></li></ul></div><div class="post__meta"><div class="post__meta__share"><h3>Share this:</h3></div></div></footer></div></div></article><div class="section post__related"><div class="wrapper"><h3 class="h4 section__title">You may also like:</h3><div class="card-container card-container--col4"><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/showing-a-listview-commandset-if-a-user-is-in-a-sharepoint-group/" class="invert">Showing a ListView CommandSet if a user is in a SharePoint Group</a></h2><p>This post is about creating a ListView CommandSet...</p><footer class="card__footer"><time datetime="2019-07-08T09:26">July 8, 2019 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Fshowing-a-listview-commandset-if-a-user-is-in-a-sharepoint-group%2F&title=Showing%20a%20ListView%20CommandSet%20if%20a%20user%20is%20in%20a%20SharePoint%20Group" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/enable-audience-targeting-using-script-or-code/" class="invert">Enable Audience targeting using script or code</a></h2><p>Currently there are no direct methods to enable...</p><footer class="card__footer"><time datetime="2019-07-18T09:26">July 18, 2019 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Fenable-audience-targeting-using-script-or-code%2F&title=Enable%20Audience%20targeting%20using%20script%20or%20code" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/finding-the-smtp-server-address-through-code-in-sharepoint-2010/" class="invert">Finding the SMTP server address through code in SharePoint 2010</a></h2><p>If anyone knows a better way then let...</p><footer class="card__footer"><time datetime="2011-02-13T11:23">February 13, 2011 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Ffinding-the-smtp-server-address-through-code-in-sharepoint-2010%2F&title=Finding%20the%20SMTP%20server%20address%20through%20code%20in%20SharePoint%202010" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article><article class="card"><div class="card__content"><h2 class="card__title"><a href="https://wutek.co.uk/using-the-bdc-to-populate-user-profiles-from-a-sql-server-database-part-two/" class="invert">Using the BDC to populate user profiles from a SQL Server database - Part Two</a></h2><p>This is the second part of a two...</p><footer class="card__footer"><time datetime="2007-11-02T09:46">November 2, 2007 </time><a href="https://getpocket.com/save?url=https%3A%2F%2Fwutek.co.uk%2Fusing-the-bdc-to-populate-user-profiles-from-a-sql-server-database-part-two%2F&title=Using%20the%20BDC%20to%20populate%20user%20profiles%20from%20a%20SQL%20Server%20database%20-%20Part%20Two" class="btn btn--clean card__readlater js-share" aria-label="Read later"><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#readlater"/></svg></a></footer></div></article></div></div></div></main><footer class="footer section section--lightest"><div class="footer__inner"><a class="logo footer__logo" href="https://wutek.co.uk/">Toby Statham</a><div class="footer__copyright"><p>Powered by Publii</p></div></div><button class="footer__bttop js-scroll-to-top" aria-label="Back to top"><svg><svg><use xlink:href="https://wutek.co.uk/assets/svg/svg-map.svg#toparrow"/></svg></svg></button></footer><script defer="defer" src="https://wutek.co.uk/assets/js/scripts.min.js?v=11cb42b202c1c2462a7002b62194e351"></script><script>window.publiiThemeMenuConfig = {    
      mobileMenuMode: 'sidebar',
      animationSpeed: 300,
      submenuWidth: 'auto',
      doubleClickTime: 500,
      mobileMenuExpandableSubmenus: true, 
      relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>